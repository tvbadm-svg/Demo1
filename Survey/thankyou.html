<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thank You - Birth Choice Conversation Guide</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="survey-container">
        <!-- Header -->
        <header class="survey-header">
            <h1>Your Birth Choice Conversation Guide</h1>
            <p class="subtitle">Deciding About a C-Section for the First Birth, or a Vaginal Birth After C-Section (VBAC) versus a Repeat C-Section (RCS)</p>
        </header>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%;"></div>
            </div>
        </div>

        <!-- Content -->
        <div class="survey-content thank-you-content">
            <h2>Thank You</h2>
            <div class="hearts">ðŸ’œ ðŸ’œ ðŸ’œ</div>
            <p>Thank you for taking the time to share all of this with us. Every detail you've provided helps us understand what matters most to you and your family.</p>
            <p>Remember, there's no rush to make this decision, and it's completely normal to have mixed feelings. We're here to support you through this process, answer any questions that come up, and respect whatever choice feels right for you.</p>
            <p class="emphasis">Your birth experience is important, and so are you. Let's work together to make sure you feel confident and supported in whatever path you choose.</p>

            <!-- Download Section -->
            <div class="download-section">
                <h3 style="font-size: 18px; color: #3B8BB8; margin-bottom: 16px;">Personalized PDF Report</h3>
                <button class="btn btn-primary" id="downloadReportBtn">
                    ðŸ“„ Download Your Personalized Report (PDF)
                </button>
                <p style="font-size: 14px; color: #666666; margin-top: 24px;">Save your response to our database [Feature Disabled]</p>
                <button class="btn btn-secondary" disabled>
                    ðŸ’¾ Save Response [Feature Disabled]
                </button>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="button-container">
            <a href="sections.html" class="btn btn-outline">Back to Sections</a>
            <a href="index.html" class="btn btn-primary">Start Over</a>
        </div>
    </div>

    <script>
        // Question paraphrase templates for brief display
        // Use {answer} placeholder for answer text, or {answerLower} for lowercase
        const questionParaphrases = {
            q1_distance_to_hospital: {
                brief: 'Hospital distance',
                template: 'I live {answer} from the hospital'
            },
            q2_neighborhood_transport: {
                brief: 'Getting around',
                template: 'I get around by {answerLower}'
            },
            q3_vehicle_type: {
                brief: 'Vehicle type',
                template: 'Vehicle: {answer}'
            },
            q4_parking: {
                brief: 'Parking',
                template: 'Parking: {answerLower}'
            },
            q5_walk_distance: {
                brief: 'Walk to home',
                template: '{answer} to home'
            },
            q6_reliable_transport: {
                brief: 'Hospital transport',
                template: 'Hospital transport: {answerLower}'
            },
            q7_car_home: {
                brief: 'Car driver available',
                template: 'Someone to drive car home: {answerLower}'
            },
            q8_infant_seat: {
                brief: 'Infant car seat',
                template: 'Infant car seat: {answerLower}'
            },
            q9_nicu_transport: {
                brief: 'NICU transport',
                template: 'NICU transport: {answerLower}'
            },
            q10_followup_transport: {
                brief: 'Follow-up transport',
                template: 'Follow-up appointments: {answerLower}'
            }
        };

        // Helper to format paraphrased text with answer
        function formatParaphrase(questionId, answerText) {
            const paraphrase = questionParaphrases[questionId];
            if (!paraphrase) return answerText;

            const answer = Array.isArray(answerText) ? answerText.join(', ') : answerText;
            return paraphrase.template
                .replace('{answer}', answer)
                .replace('{answerLower}', answer.toLowerCase());
        }

        // Scoring rules based on transport_distance_ruleset.yaml
        const scoringRules = {
            q1_distance_to_hospital: {
                '15-30': { score: 0, flags: [], actions: [] },
                '30-60': { score: 1, flags: ['Distance_Moderate'], actions: ['Identify fastest route(s) at different times of day; confirm a backup route.'] },
                '60-90': { score: 2, flags: ['Distance_High'], actions: ['Discuss early-labor departure thresholds with your clinician; consider arriving earlier.'] },
                '90+': { score: 3, flags: ['Distance_Critical'], actions: ['Create a clear departure plan; discuss timing/arrival strategy with your clinician.', 'Identify an emergency alternative (closest facility) for urgent situations.'] }
            },
            q2_neighborhood_transport: {
                'drive': { score: 0, flags: [], actions: [] },
                'taxi': { score: 1, flags: ['Transport_DependsOnRideshare'], actions: ['List 2+ ride options; verify late-night availability; confirm payment method.'] },
                'public': { score: 2, flags: ['Transport_DependsOnPublicTransit'], actions: ['Map routes to the hospital (including nights/weekends); define a backup ride.'] },
                'walk': { score: 2, flags: ['Transport_WalkingPrimary'], actions: ['Identify who can drive you in labor; plan for weather/ice and timing.'] }
            },
            q3_vehicle_type: {
                'sedan': { score: 0, flags: [], actions: [] },
                'sports': { score: 1, flags: ['Vehicle_LowClearance'], actions: ['Plan for easier entry/exit; consider an alternate vehicle for labor/discharge.'] },
                'suv': { score: 1, flags: ['Vehicle_HighStepUp'], actions: ['Plan step support; consider postpartum comfort getting in/out.'] },
                'none': { score: 2, flags: ['NoVehicle'], actions: ['Build Plan A/B/C transportation for labor, discharge, and newborn visits.'], resources: ['Check whether your insurance offers non-emergency medical transportation.'] }
            },
            q4_parking: {
                'garage': { score: 0, flags: [], actions: [] },
                'street': { score: 1, flags: ['Parking_Street'], actions: ['Plan for carrying items and winter/ice; identify safest typical parking spots.'] },
                'distant': { score: 2, flags: ['Parking_Distant'], actions: ['Arrange door-to-door help after delivery; plan safe route and lighting.'] },
                'parking_garage': { score: 1, flags: ['Parking_Garage'], actions: ['Plan elevator access and carrying items; consider safety and lighting.'] },
                'no_vehicle': { score: 0, flags: [], actions: [] }
            },
            q5_walk_distance: {
                'very_short': { score: 0, flags: [], actions: [] },
                'short': { score: 1, flags: [], actions: [] },
                'moderate': { score: 2, flags: ['HomeAccess_ModerateWalk'], actions: ['Plan for postpartum mobility limits; arrange help carrying items.'] },
                'long': { score: 3, flags: ['HomeAccess_LongWalk'], actions: ['Plan door-to-door help for first 1â€“2 weeks postpartum; avoid carrying heavy items.'] }
            },
            q6_reliable_transport: {
                'multiple': { score: 0, flags: [], actions: [] },
                'one_good': { score: 1, flags: ['HospitalTransport_SinglePointOfFailure'], actions: ['Create a backup option (Plan B) with a named person/company.'] },
                'somewhat': { score: 3, flags: ['HospitalTransport_Uncertain'], actions: ['Create Plan A/B/C; define "when to leave" triggers with your clinician.'] },
                'not_reliable': { score: 4, flags: ['HospitalTransport_Unreliable'], actions: ['Treat transportation planning as a priority safety item; involve your care team now.'], resources: ['Ask hospital social work/case management about transportation support.'] }
            },
            q7_car_home: {
                'yes': { score: 0, flags: [], actions: [] },
                'not_sure': { score: 1, flags: ['CarReturn_Uncertain'], actions: ['Name the person now; confirm they can come at any hour; plan a spare key.'] },
                'no': { score: 2, flags: ['CarReturn_NoDriver'], actions: ['Plan for parking duration/fees; plan discharge ride; consider being driven to hospital.'] },
                'no_vehicle': { score: 0, flags: [], actions: [] }
            },
            q8_infant_seat: {
                'yes': { score: 0, flags: [], actions: ['Install/check fit and know where it is before you leave for the hospital.'] },
                'plan_to_get': { score: 1, flags: ['CarSeat_Pending'], actions: ['Set a deadline to obtain it; practice installation.'] },
                'not_sure_how': { score: 3, flags: ['CarSeat_Barrier'], actions: ['Resolve before delivery/discharge; connect to support resources.'], resources: ['Ask hospital/clinic social work about car-seat resources.'] },
                'dont_know': { score: 2, flags: ['CarSeat_KnowledgeGap'], actions: ['Review discharge expectations and transportation plan for going home.'] }
            },
            q9_nicu_transport: {
                'reliable': { score: 0, flags: [], actions: [] },
                'arrange_hard': { score: 2, flags: ['NICU_Transport_Hard'], actions: ['Create visiting schedule and pumping/storage plan; identify 2 helpers.'], resources: ['Connect with NICU social work and lactation support.'] },
                'need_assistance': { score: 3, flags: ['NICU_Transport_NeedsAssistance'], actions: ['Connect to hospital social work early; ask about lodging/transport support.'] },
                'formula': { score: 1, flags: ['NICU_FeedingFormula'], actions: ['Still plan transportation for visitation and communication with NICU team.'] },
                'not_sure': { score: 4, flags: ['NICU_Transport_Uncertain'], actions: ['Escalate planning now; identify options and connect to support resources.'] }
            },
            q10_followup_transport: {
                'multiple': { score: 0, flags: [], actions: [] },
                'one_option': { score: 1, flags: ['FollowUpTransport_AdvancePlanning'], actions: ['Pre-schedule rides for first appointments once dates are known.'] },
                'arrange_services': { score: 2, flags: ['FollowUpTransport_InsuranceDependent'], actions: ['Call insurer now to confirm benefit rules, lead time, and limits.'] },
                'dont_know': { score: 4, flags: ['FollowUpTransport_Uncertain'], actions: ['Create a plan now and ask clinic/hospital for resource support.'] }
            }
        };

        // Risk level bands (per transport_distance_ruleset.yaml)
        const riskBands = {
            low: [0, 2],
            moderate: [3, 5],
            high: [6, 8],
            very_high: [9, 12],
            critical: [13, 28]
        };

        function getRiskLevel(score) {
            if (score <= 2) return { level: 'Low', color: '#4CAF50' };
            if (score <= 5) return { level: 'Moderate', color: '#FFC107' };
            if (score <= 8) return { level: 'High', color: '#FF9800' };
            if (score <= 12) return { level: 'Very High', color: '#E65100' };
            return { level: 'Critical', color: '#F44336' };
        }

        function generateReport(responses) {
            let totalScore = 0;
            const allFlags = [];
            const allActions = [];
            const allResources = [];
            const solidItems = [];
            const flaggedItems = [];
            const questionActions = {}; // Track actions per question

            if (!responses || !responses.questions) {
                return null;
            }

            responses.questions.forEach(q => {
                const rules = scoringRules[q.id];
                if (!rules) return;

                questionActions[q.id] = []; // Initialize actions array for this question

                // Handle array answers (checkboxes)
                if (Array.isArray(q.answer)) {
                    q.answer.forEach(ans => {
                        const rule = rules[ans];
                        if (rule) {
                            totalScore += rule.score;
                            if (rule.flags) allFlags.push(...rule.flags);
                            if (rule.actions) {
                                allActions.push(...rule.actions);
                                questionActions[q.id].push(...rule.actions);
                            }
                            if (rule.resources) allResources.push(...rule.resources);

                            if (rule.score === 0 && rule.flags.length === 0) {
                                // Get answer text for this specific checkbox option
                                const checkbox = document.querySelector(`input[value="${ans}"]`);
                                const ansText = checkbox ? checkbox.nextElementSibling?.textContent : ans;
                                solidItems.push(formatParaphrase(q.id, ansText));
                            } else if (rule.flags.length > 0) {
                                flaggedItems.push({ question: q.text, answer: ans, flags: rule.flags });
                            }
                        }
                    });
                } else {
                    // Single answer
                    const rule = rules[q.answer];
                    if (rule) {
                        totalScore += rule.score;
                        if (rule.flags) allFlags.push(...rule.flags);
                        if (rule.actions) {
                            allActions.push(...rule.actions);
                            questionActions[q.id].push(...rule.actions);
                        }
                        if (rule.resources) allResources.push(...rule.resources);

                        if (rule.score === 0 && rule.flags.length === 0) {
                            solidItems.push(formatParaphrase(q.id, q.answerText));
                        } else if (rule.flags && rule.flags.length > 0) {
                            flaggedItems.push({ question: q.text, answer: q.answerText, flags: rule.flags });
                        }
                    }
                }
            });

            const riskLevel = getRiskLevel(totalScore);

            return {
                score: totalScore,
                riskLevel: riskLevel,
                flags: [...new Set(allFlags)],
                actions: [...new Set(allActions)],
                resources: [...new Set(allResources)],
                solidItems: solidItems,
                flaggedItems: flaggedItems,
                questionActions: questionActions,
                timestamp: responses.timestamp
            };
        }

        function formatReportForPR(report, responses) {
            const timestamp = new Date(report.timestamp).toLocaleString();

            let markdown = `# Birth Choice Survey - Personalized Report\n\n`;
            markdown += `**Generated:** ${timestamp}\n`;
            markdown += `**Theme:** Transportation and Distance Factors ðŸš—\n\n`;
            markdown += `---\n\n`;
            markdown += `## Overall Assessment\n\n`;
            markdown += `- **Risk Score:** ${report.score}/28\n`;
            markdown += `- **Risk Level:** ${report.riskLevel.level}\n\n`;

            if (report.solidItems.length > 0) {
                markdown += `## âœ… What Looks Solid\n\n`;
                report.solidItems.forEach(item => {
                    markdown += `- ${item}\n`;
                });
                markdown += `\n`;
            }

            if (report.flaggedItems.length > 0) {
                markdown += `## âš ï¸ Things to Focus On\n\n`;
                report.flaggedItems.forEach(item => {
                    markdown += `- **${item.question}**\n`;
                    markdown += `  - Answer: ${item.answer}\n`;
                    markdown += `  - Flags: ${item.flags.join(', ')}\n`;
                });
                markdown += `\n`;
            }

            if (report.resources.length > 0) {
                markdown += `## ðŸ¤ Support Resources\n\n`;
                report.resources.forEach(resource => {
                    markdown += `- ${resource}\n`;
                });
                markdown += `\n`;
            }

            markdown += `---\n\n`;
            markdown += `## Survey Responses\n\n`;
            markdown += `| Question | Response | Your Action Items |\n`;
            markdown += `|----------|----------|-------------------|\n`;
            responses.questions.forEach(q => {
                const answer = Array.isArray(q.answerText) ? q.answerText.join(', ') : q.answerText;
                if (answer && answer !== 'Select an option...') {
                    const paraphrase = questionParaphrases[q.id];
                    const briefQuestion = paraphrase ? paraphrase.brief : q.text;
                    const actions = report.questionActions[q.id] || [];
                    const actionText = actions.length > 0 ? actions.join(' ') : 'â€”';
                    markdown += `| ${briefQuestion} | ${answer} | ${actionText} |\n`;
                }
            });

            return markdown;
        }

        function downloadPDF(report, responses) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const timestamp = new Date(report.timestamp).toLocaleString();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);
            let yPos = 20;

            // Helper function to add text with word wrap and page break handling
            function addText(text, fontSize, isBold, color, indent = 0) {
                doc.setFontSize(fontSize);
                doc.setFont('helvetica', isBold ? 'bold' : 'normal');
                if (color) {
                    doc.setTextColor(color[0], color[1], color[2]);
                } else {
                    doc.setTextColor(0, 0, 0);
                }

                const lines = doc.splitTextToSize(text, contentWidth - indent);
                lines.forEach(line => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(line, margin + indent, yPos);
                    yPos += fontSize * 0.5;
                });
                yPos += 2;
            }

            // Title
            doc.setTextColor(43, 112, 150); // #2B7096
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Birth Choice Survey', margin, yPos);
            yPos += 8;
            doc.text('Personalized Report', margin, yPos);
            yPos += 12;

            // Metadata
            addText(`Generated: ${timestamp}`, 10, false, [100, 100, 100]);
            addText('Theme: Transportation and Distance Factors', 10, false, [100, 100, 100]);
            yPos += 5;

            // Horizontal line
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 10;

            // Overall Assessment
            addText('Overall Assessment', 14, true, [43, 112, 150]);
            yPos += 2;
            addText(`Risk Score: ${report.score}/28`, 11, false);

            // Risk level with color
            const riskColors = {
                'Low': [76, 175, 80],
                'Moderate': [255, 193, 7],
                'High': [255, 152, 0],
                'Very High': [230, 81, 0],
                'Critical': [244, 67, 54]
            };
            addText(`Risk Level: ${report.riskLevel.level}`, 11, true, riskColors[report.riskLevel.level] || [0, 0, 0]);
            yPos += 5;

            // What Looks Solid
            if (report.solidItems.length > 0) {
                addText('What Looks Solid', 14, true, [76, 175, 80]);
                yPos += 2;
                report.solidItems.forEach(item => {
                    addText(`â€¢ ${item}`, 10, false, null, 5);
                });
                yPos += 5;
            }

            // Things to Focus On
            if (report.flaggedItems.length > 0) {
                addText('Things to Focus On', 14, true, [255, 152, 0]);
                yPos += 2;
                report.flaggedItems.forEach(item => {
                    addText(`â€¢ ${item.question}`, 10, true, null, 5);
                    addText(`Answer: ${item.answer}`, 9, false, [100, 100, 100], 10);
                    addText(`Flags: ${item.flags.join(', ')}`, 9, false, [100, 100, 100], 10);
                });
                yPos += 5;
            }

            // Support Resources
            if (report.resources.length > 0) {
                addText('Support Resources', 14, true, [59, 139, 184]);
                yPos += 2;
                report.resources.forEach(resource => {
                    addText(`â€¢ ${resource}`, 10, false, null, 5);
                });
                yPos += 5;
            }

            // Page break before survey responses if needed
            if (yPos > 200) {
                doc.addPage();
                yPos = 20;
            }

            // Horizontal line
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 10;

            // Survey Responses - Table Format
            addText('Survey Responses', 14, true, [43, 112, 150]);
            yPos += 5;

            // Table dimensions - 3 columns
            const tableStartX = margin;
            const colWidth1 = 35; // Question column
            const colWidth2 = 40; // Response column
            const colWidth3 = contentWidth - colWidth1 - colWidth2; // Action Items column
            const cellPadding = 2;

            // Helper function to calculate row height based on content
            function getRowHeight(lines) {
                return Math.max(8, lines * 4 + 4);
            }

            // Table header
            doc.setFillColor(240, 240, 240);
            doc.rect(tableStartX, yPos, colWidth1, 8, 'F');
            doc.rect(tableStartX + colWidth1, yPos, colWidth2, 8, 'F');
            doc.rect(tableStartX + colWidth1 + colWidth2, yPos, colWidth3, 8, 'F');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(43, 112, 150);
            doc.text('Question', tableStartX + cellPadding, yPos + 5);
            doc.text('Response', tableStartX + colWidth1 + cellPadding, yPos + 5);
            doc.text('Your Action Items', tableStartX + colWidth1 + colWidth2 + cellPadding, yPos + 5);
            yPos += 8;

            // Table rows
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);

            responses.questions.forEach(q => {
                const answer = Array.isArray(q.answerText) ? q.answerText.join(', ') : q.answerText;
                if (answer && answer !== 'Select an option...') {
                    // Get action items for this question
                    const actions = report.questionActions[q.id] || [];
                    const actionText = actions.length > 0 ? actions.join(' ') : 'â€”';

                    // Get brief question text
                    const paraphrase = questionParaphrases[q.id];
                    const briefQuestion = paraphrase ? paraphrase.brief : q.text.substring(0, 20);

                    // Calculate wrapped text for action items
                    doc.setFontSize(7);
                    const wrappedActions = doc.splitTextToSize(actionText, colWidth3 - (cellPadding * 2));
                    const rowHeight = getRowHeight(wrappedActions.length);

                    // Check for page break
                    if (yPos + rowHeight > 270) {
                        doc.addPage();
                        yPos = 20;
                    }

                    // Draw row borders
                    doc.setDrawColor(220, 220, 220);
                    doc.rect(tableStartX, yPos, colWidth1, rowHeight);
                    doc.rect(tableStartX + colWidth1, yPos, colWidth2, rowHeight);
                    doc.rect(tableStartX + colWidth1 + colWidth2, yPos, colWidth3, rowHeight);

                    // Draw text
                    doc.setFontSize(8);
                    doc.setTextColor(60, 60, 60);
                    doc.text(briefQuestion, tableStartX + cellPadding, yPos + 5);

                    // Truncate answer if needed to fit
                    const maxAnswerWidth = colWidth2 - (cellPadding * 2);
                    let displayAnswer = answer;
                    while (doc.getTextWidth(displayAnswer) > maxAnswerWidth && displayAnswer.length > 10) {
                        displayAnswer = displayAnswer.substring(0, displayAnswer.length - 4) + '...';
                    }
                    doc.text(displayAnswer, tableStartX + colWidth1 + cellPadding, yPos + 5);

                    // Draw action items (wrapped)
                    doc.setFontSize(7);
                    doc.setTextColor(80, 80, 80);
                    wrappedActions.forEach((line, idx) => {
                        doc.text(line, tableStartX + colWidth1 + colWidth2 + cellPadding, yPos + 5 + (idx * 4));
                    });

                    yPos += rowHeight;
                }
            });

            // Save the PDF
            const filename = `BirthChoice_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
        }

        // Button click handler
        document.getElementById('downloadReportBtn').addEventListener('click', function() {
            // Get survey responses from localStorage
            const storedResponses = localStorage.getItem('birthChoiceSurvey_transportation');

            if (!storedResponses) {
                alert('No survey responses found. Please complete the survey first.');
                window.location.href = 'transportation.html';
                return;
            }

            const responses = JSON.parse(storedResponses);
            const report = generateReport(responses);

            if (!report) {
                alert('Unable to generate report. Please complete the survey again.');
                window.location.href = 'transportation.html';
                return;
            }

            // Download the PDF
            downloadPDF(report, responses);
        });
    </script>
</body>
</html>
